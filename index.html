<!DOCTYPE html>
<html>
<head>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<title>Cat-tris</title>
<style>body{margin:0;padding:20px;font-family:monospace;background:#000;color:#fff}
#game{width:240px;height:360px;border:2px solid #9B6AF6;display:block}
#tournaments{position:fixed;top:20px;right:20px;background:rgba(0,0,0,0.9);padding:15px;border:2px solid #9B6AF6;border-radius:10px;display:none}
#tournaments button{width:100%;margin:3px 0;padding:8px;background:#9B6AF6;color:white;border:none;border-radius:5px;cursor:pointer}
#tournaments input{width:100%;margin:3px 0;padding:8px;border-radius:5px;border:1px solid #9B6AF6;background:#111;color:white}
</style>
</head>
<body>
<canvas id="game"></canvas>

<div id="tournaments">
<button onclick="toggle()">üèÜ TOURNAMENTS</button>
<div>
<button onclick="show('create')">CREATE</button>
<button onclick="show('join')">JOIN</button>

<div id="create">
<input id="name" value="Cat Battle">
<input id="time" type="number" value="30">
<button onclick="create()">CREATE</button>
</div>

<div id="join" style="display:none">
<input id="code" placeholder="CODE">
<input id="player" placeholder="Name">
<button onclick="join()">JOIN</button>
</div>

<div id="lobby" style="display:none">
<div id="room"></div>
<div id="players"></div>
<button onclick="start()">START</button>
</div>
</div>
</div>

<script>
const canvas=document.getElementById('game'),ctx=canvas.getContext('2d');
canvas.width=240;canvas.height=360;

const SUPABASE_URL='https://lsdwavmfkbfrnbmeqiov.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzZHdhdm1ma2Jmcm5ibWVxaW92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwNzgxMTUsImV4cCI6MjA4MjY1NDExNX0.umbN5OiY95pZMymq3ufuD-jdKdobLScgqqj-57QtU8Y';
const supabase=Supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

let arena=createMatrix(10,15),player={pos:{x:0,y:0},matrix:null,score:0},dropCounter=0,dropInterval=800,lastTime=0,gameStarted=false;
let channel=null,currentRoom=null,timeLeft=0,leaderboard={};

function createMatrix(w,h){const m=[];while(h--)m.push(new Array(w).fill(0));return m}
function createPiece(type){if(type==='T')return[[0,0,0],[1,1,1],[0,1,0]];return[[1,1],[1,1]]}
function collide(a,p){const[m,o]=[p.matrix,p.pos];for(let y=0;y<m.length;++y)for(let x=0;x<m[y].length;++x)if(m[y][x]!==0&&(a[y+o.y]&&a[y+o.y][x+o.x])!==0)return true;return false}
function merge(a,p){p.matrix.forEach((r,y)=>r.forEach((v,x)=>{if(v!==0)a[y+p.pos.y][x+p.pos.x]=v}))}
function playerReset(){player.matrix=createPiece('TILOSZ'[Math.random()*6|0]);player.pos.y=0;player.pos.x=3;if(collide(arena,player)){arena.forEach(r=>r.fill(0));player.score=0;gameStarted=false}}
function playerDrop(){player.pos.y++;if(collide(arena,player)){player.pos.y--;merge(arena,player);playerReset()}dropCounter=0}
function playerMove(d){player.pos.x+=d;if(collide(arena,player))player.pos.x-=d}
function updateScore(){document.getElementById('score').outerHTML=`Score: ${player.score}`;if(channel&&gameStarted)channel.send({type:'broadcast',event:'score',payload:{name:playerName,score:player.score}})}

function draw(){ctx.fillStyle='#000';ctx.fillRect(0,0,240,360);drawMatrix(arena,{x:0,y:0});if(gameStarted&&player.matrix)drawMatrix(player.matrix,player.pos)}
function drawMatrix(m,o){m.forEach((r,y)=>r.forEach((v,x)=>{if(v){ctx.fillStyle=`hsl(${v*40},100%,50%)`;ctx.fillRect((x+o.x)*24,(y+o.y)*24,23,23)}}))}
function update(t=0){const d=t-lastTime;lastTime=t;dropCounter+=d;if(dropCounter>dropInterval&&gameStarted)playerDrop();draw();requestAnimationFrame(update)}

function toggle(){document.getElementById('tournaments').style.display=document.getElementById('tournaments').style.display==='none'?'block':'none'}
function show(tab){document.getElementById('create').style.display=tab==='create'?'block':'none';document.getElementById('join').style.display=tab==='join'?'block':'none'}
async function create(){const name=document.getElementById('name').value,dur=parseInt(document.getElementById('time').value),code=Math.random().toString(36).slice(2,6).toUpperCase();await supabase.from('tournaments').insert({code,name,duration:dur});currentRoom={code,name,dur};join(code)}
async function join(code=''){if(!code)code=document.getElementById('code').value.toUpperCase(),playerName=document.getElementById('player').value||'Anon';channel=supabase.channel('room:'+code);await channel.subscribe();channel.on('broadcast',{event:'score'},p=>{leaderboard[p.payload.name]=p.payload.score;document.getElementById('players').innerHTML=Object.entries(leaderboard).sort(([,a],[,b])=>b-a).map(([n,s])=>`${n}: ${s}`).join('<br>')});document.getElementById('room').textContent=`Room: ${code}`;document.getElementById('lobby').style.display='block'}
function start(){timeLeft=currentRoom.duration;const t=setInterval(()=>{timeLeft--;if(timeLeft<=0){clearInterval(t);alert('FINISHED!');document.getElementById('tournaments').style.display='block'}},1000);document.getElementById('tournaments').style.display='none';gameStarted=true;playerReset()}

document.addEventListener('keydown',e=>{if(e.key==='t')toggle();if(e.key==='Enter')gameStarted=true,playerReset();if(!gameStarted)return;if(e.keyCode===37)playerMove(-1);if(e.keyCode===39)playerMove(1);if(e.keyCode===40)playerDrop();if(e.keyCode===38)playerRotate()});
playerReset();updateScore();update();
</script>
<div style="position:fixed;bottom:10px;right:10px;color:#9B6AF6;font-size:12px">T=Menu | Enter=Start</div>
</body>
</html>
