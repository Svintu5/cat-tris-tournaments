<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <title>üòª Cat-tris TOURNAMENTS</title>
  <!-- –í–µ—Å—å —Ç–≤–æ–π CSS –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
  <style>
    /* ... —Ç–≤–æ–π CSS ... */
    
    /* –î–û–ë–ê–í–¨ –≠–¢–û –≤ –∫–æ–Ω–µ—Ü <style> */
    .tournaments-panel {
      position: fixed; top: 20px; right: 20px;
      background: rgba(0,0,0,0.95); border: 2px solid #9B6AF6;
      border-radius: 16px; padding: 16px; max-width: 280px;
      backdrop-filter: blur(12px); font-size: 12px;
      box-shadow: 0 8px 32px rgba(155,106,246,0.3);
    }
    .tournaments-panel button, .tournaments-panel input {
      width: 100%; margin: 4px 0; padding: 8px; border-radius: 8px;
      border: none; background: #9B6AF6; color: white; font-weight: 500;
    }
    .tournaments-panel button:hover { background: #E37DF7; }
  </style>
</head>
<body>
  <!-- –¢–í–æ–π HTML –¥–æ </div> machine –ö–û–ü–ò–†–£–ô –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô -->
  <div class="machine">...</div>

  <!-- ‚úÖ –¢–£–†–ù–ò–†–´ –ü–ï–†–ï–î </body> -->
  <div id="tournaments" class="tournaments-panel" style="display:none">
    <button onclick="toggleTournaments()">üèÜ TOURNAMENTS (T)</button>
    <div id="tournamentsContent">
      <div style="display:flex; gap:4px">
        <button class="tab active" onclick="showTab('create')">CREATE</button>
        <button class="tab" onclick="showTab('join')">JOIN</button>
      </div>
      
      <div id="createTab">
        <input id="roomName" placeholder="Room name" value="Koto Battle">
        <input id="duration" type="number" value="300" min="60" max="900"> sec
        <button onclick="createRoom()">CREATE ROOM</button>
      </div>
      
      <div id="joinTab" style="display:none">
        <input id="roomCode" placeholder="Enter CODE">
        <input id="playerName" placeholder="Your name">
        <button onclick="joinRoomUI()">JOIN</button>
      </div>
      
      <div id="lobby" style="display:none">
        <div id="roomInfo" style="font-weight:600; margin-bottom:8px"></div>
        <div id="players" style="max-height:120px; overflow:auto"></div>
        <button id="startBtn" onclick="startTournament()">üöÄ START GAME</button>
        <div id="countdown"></div>
      </div>
    </div>
  </div>

  <!-- –¢–í–æ–π —Å–∫—Ä–∏–ø—Ç –∏–≥—Ä—ã (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô) -->
  <script>
    // ... –≤–µ—Å—å —Ç–≤–æ–π –∫–æ–¥ —Ç–µ—Ç—Ä–∏—Å–∞ ...
    
    // ‚úÖ –ì–õ–ê–í–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –í –¢–í–û–Å–ú –ö–û–î–ï:
    
    // 1. –°–¥–µ–ª–∞–π gameStarted –≥–ª–æ–±–∞–ª—å–Ω–æ–π
    window.gameStarted = false; // –≤–º–µ—Å—Ç–æ let gameStarted
    
    // 2. –í updateScore() –¥–æ–±–∞–≤—å –æ—Ç–ø—Ä–∞–≤–∫—É –≤ Supabase
    function updateScore() {
      document.getElementById('score').textContent = player.score;
      if (player.score > topScore) {
        topScore = player.score;
        localStorage.setItem('cattris_top_score', topScore);
      }
      document.getElementById('topScore').textContent = topScore;
      
      // ‚úÖ –û–¢–ü–†–ê–í–ö–ê –í –¢–£–†–ù–ò–†
      if (window.channel && window.gameStarted) {
        window.sendScore();
      }
    }
    
    // 3. –í update() —Ä–∏—Å—É–π —Ç–∞–π–º–µ—Ä
    function update(time = 0) {
      // ... —Ç–≤–æ–π –∫–æ–¥ ...
      
      // ‚úÖ –¢–ê–ô–ú–ï–† –¢–£–†–ù–ò–†–ê
      if (window.timeLeft > 0) {
        context.fillStyle = '#E37DF7';
        context.font = 'bold 18px monospace';
        context.textAlign = 'left';
        context.fillText(
          `‚è± ${Math.floor(window.timeLeft/60)}:${(window.timeLeft%60).toString().padStart(2,'0')}`,
          8, 28
        );
      }
      
      draw();
      requestAnimationFrame(update);
    }
  </script>

  <!-- ‚úÖ SUPABASE (–ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–∫—Ä–∏–ø—Ç) -->
  <script>
    const SUPABASE_URL = 'https://lsdwavmfkbfrnbmeqiov.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzZHdhdm1ma2Jmcm5ibWVxaW92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwNzgxMTUsImV4cCI6MjA4MjY1NDExNX0.umbN5OiY95pZMymq3ufuD-jdKdobLScgqqj-57QtU8Y';
    
    const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let channel = null;
    let currentRoom = null;
    let timeLeft = 0;
    let leaderboard = {};
    
    // ‚úÖ –ö–õ–ê–í–ò–®–ê T
    document.addEventListener('keydown', e => {
      if (e.key.toLowerCase() === 't') toggleTournaments();
    });
    
    function toggleTournaments() {
      const panel = document.getElementById('tournaments');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }
    
    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      
      document.getElementById('createTab').style.display = tab === 'create' ? 'block' : 'none';
      document.getElementById('joinTab').style.display = tab === 'join' ? 'block' : 'none';
    }
    
    async function createRoom() {
      const name = document.getElementById('roomName').value || 'Cat Battle';
      const duration = parseInt(document.getElementById('duration').value);
      const code = Math.random().toString(36).slice(2,6).toUpperCase();
      
      await supabase.from('tournaments').insert({code, name, duration});
      
      currentRoom = {code, name, duration};
      window.currentRoom = currentRoom;
      
      document.getElementById('roomInfo').textContent = `Room: ${code}`;
      document.getElementById('lobby').style.display = 'block';
      alert(`‚úÖ Room ${code} created! Share the code!`);
    }
    
    async function joinRoomUI() {
      const code = document.getElementById('roomCode').value.toUpperCase();
      const playerName = document.getElementById('playerName').value || 'Anonymous';
      
      window.playerName = playerName;
      currentRoom = {code};
      window.currentRoom = currentRoom;
      
      channel = supabase.channel(`room:${code}`);
      await channel.subscribe();
      window.channel = channel;
      
      // ‚úÖ –ê–í–¢–û-–û–¢–ü–†–ê–í–ö–ê –°–ß–Å–¢–ê
      window.sendScore = () => {
        if (channel && window.gameStarted) {
          channel.send({
            type: 'broadcast',
            event: 'score',
            payload: {name: playerName, score: window.player?.score || 0}
          });
        }
      };
      
      // ‚úÖ –õ–ò–î–ï–†–ë–û–†–î
      channel.on('broadcast', {event: 'score'}, ({payload}) => {
        leaderboard[payload.name] = payload.score;
        updateLeaderboard();
      });
      
      document.getElementById('roomInfo').textContent = `Room: ${code}`;
      document.getElementById('lobby').style.display = 'block';
    }
    
    function updateLeaderboard() {
      const playersDiv = document.getElementById('players');
      const sorted = Object.entries(leaderboard).sort(([,a],[,b]) => b-a);
      playersDiv.innerHTML = sorted.map(([name, score]) => 
        `<div>${name}: ${score}</div>`
      ).join('');
    }
    
    function startTournament() {
      timeLeft = window.currentRoom.duration;
      window.timeLeft = timeLeft;
      
      const timer = setInterval(() => {
        timeLeft--;
        window.timeLeft = timeLeft;
        document.getElementById('countdown').textContent = 
          `${Math.floor(timeLeft/60)}:${timeLeft%60.toString().padStart(2,'0')}`;
        
        if (timeLeft <= 0) {
          clearInterval(timer);
          alert('‚è∞ Tournament finished!');
          document.getElementById('tournaments').style.display = 'block';
        }
      }, 1000);
      
      document.getElementById('tournaments').style.display = 'none';
      window.gameStarted = true;
      window.playerReset();
    }
  </script>
</body>
</html>
