<script>
const API_BASE = `${location.origin}/api/tournament`;

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
async function apiCall(action, data = {}) {
  console.log('üåê API –∑–∞–ø—Ä–æ—Å:', action, data);
  
  const res = await fetch(API_BASE, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action, ...data })
  });
  
  console.log('üì° –°—Ç–∞—Ç—É—Å:', res.status, res.statusText);
  
  if (!res.ok) {
    const error = await res.json();
    console.error('‚ùå –û—à–∏–±–∫–∞ API:', error);
    throw new Error(error.error || '–û—à–∏–±–∫–∞ API');
  }
  
  const result = await res.json();
  console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç API:', result);
  return result;
}

function sanitizeName(name) {
  return name.trim().replace(/[<>'"]/g, '').slice(0, 12);
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ –∫–æ–º–Ω–∞—Ç—ã (–ü–†–û–°–¢–ê–Ø)
function generateUniqueRoomCode() {
  const code = Math.random().toString(36).slice(2, 6).toUpperCase();
  console.log('üé≤ –ö–æ–¥:', code);
  return code;
}

  // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ DOM –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
  document.addEventListener('DOMContentLoaded', () => {

// –°–û–ó–î–ê–¢–¨ –ö–û–ú–ù–ê–¢–£
document.getElementById('createBtn').onclick = async () => {
  const nameInput = document.getElementById('playerName');
  const createBtn = document.getElementById('createBtn');
  const hostName = sanitizeName(nameInput.value || 'Host');
  
  if (!hostName) return alert('üë§ –í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫!');

  createBtn.disabled = true;
  createBtn.textContent = 'üîÑ –°–û–ó–î–ê–Å–ú...';

  try {
    const roomCode = generateUniqueRoomCode();
    console.log('‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞:', roomCode);
    
    const room = {
      code: roomCode,
      host: hostName,
      name: `–ë–∏—Ç–≤–∞ ${hostName} –≤ Cat-tris`,
      status: 'waiting',
      players: [hostName],
      scores: { [hostName]: 0 },
      played: { [hostName]: false },
      createdAt: new Date().toISOString()
    };

    console.log('üíæ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º:', room);
    await apiCall('save_room', { code: roomCode, room });
    
    localStorage.setItem('cattris_player_name', hostName);
    
    alert(`‚úÖ –ö–æ–º–Ω–∞—Ç–∞ ${roomCode} —Å–æ–∑–¥–∞–Ω–∞!`);
    window.location.href = 
      `game.html?room=${roomCode}&name=${encodeURIComponent(hostName)}&role=host`;
  } catch (err) {
    console.error('‚ùå –û—à–∏–±–∫–∞:', err);
    alert(`‚ùå –û—à–∏–±–∫–∞: ${err.message}`);
  } finally {
    createBtn.disabled = false;
    createBtn.textContent = 'üöÄ CREATE';
  }
};

// –í–û–ô–¢–ò –í –ö–û–ú–ù–ê–¢–£
document.getElementById('joinBtn').onclick = async () => {
  const nameInput = document.getElementById('playerName');
  const roomInput = document.getElementById('roomCode');
  const joinBtn = document.getElementById('joinBtn');
  
  const playerName = sanitizeName(nameInput.value || 'Player');
  const roomCode = roomInput.value.trim().toUpperCase();

  if (!playerName) return alert('üë§ –í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫!');
  if (!roomCode || roomCode.length !== 4) {
    return alert('üìù –í–≤–µ–¥–∏—Ç–µ 4-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥!');
  }

  joinBtn.disabled = true;
  joinBtn.textContent = 'üîÑ –í–•–û–î–ò–ú...';

  try {
    const { room } = await apiCall('join_room', { 
      code: roomCode, 
      playerName 
    });

    localStorage.setItem('cattris_player_name', playerName);
    alert(`‚úÖ –í—ã –≤–æ—à–ª–∏ –≤ ${room.name}!`);
    window.location.href = 
      `game.html?room=${roomCode}&name=${encodeURIComponent(playerName)}&role=player`;
  } catch (err) {
    console.error(err);
    
    if (err.message.includes('already started')) {
      alert('üèÅ –¢—É—Ä–Ω–∏—Ä —É–∂–µ –Ω–∞—á–∞–ª—Å—è!');
    } else if (err.message.includes('already taken')) {
      alert('üë§ –ò–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ!');
    } else if (err.message.includes('not found')) {
      alert('‚ùå –ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
    } else {
      alert(`‚ùå –û—à–∏–±–∫–∞: ${err.message}`);
    }
  } finally {
    joinBtn.disabled = false;
    joinBtn.textContent = '‚ö° JOIN';
  }
};

// –ê–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
document.getElementById('roomCode').oninput = (e) => {
  e.target.value = e.target.value
    .toUpperCase()
    .replace(/[^A-Z0-9]/g, '')
    .slice(0, 4);
};

// Enter –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–≤—Ö–æ–¥–∞
document.getElementById('playerName').onkeypress = 
document.getElementById('roomCode').onkeypress = (e) => {
  if (e.key === 'Enter') {
    const roomCode = document.getElementById('roomCode').value;
    if (roomCode.trim()) {
      document.getElementById('joinBtn').click();
    } else {
      document.getElementById('createBtn').click();
    }
  }
};

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–º—è
const saved = localStorage.getItem('cattris_player_name');
    if (saved) {
        document.getElementById('playerName').value = saved;
      }

                            }); // –∫–æ–Ω–µ—Ü DOMContentLoaded
