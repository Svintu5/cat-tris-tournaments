<script>
  const urlParams = new URLSearchParams(window.location.search);
  const roomCode = urlParams.get('room');
  
  const SUPABASE_URL = 'https://lsdwavmfkbfrnbmeqiov.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzZHdhdm1ma2Jmcm5ibWVxaW92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwNzgxMTUsImV4cCI6MjA4MjY1NDExNX0.umbN5OiY95pZMymq3ufuD-jdKdobLScgqqj-57QtU8Y';

  if (!roomCode) {
    document.querySelector('.room-title').innerHTML = '‚ùå No room specified';
    document.querySelector('#leaderboard div').innerHTML = '<a href="index.html">‚Üê Go to lobby</a>';
    throw new Error('No room code');
  }

  let supabaseClient = null;

  // üî• –ñ–î–Å–ú –ó–ê–ì–†–£–ó–ö–£ SUPABASE
  async function initSupabase() {
    if (typeof supabase === 'undefined') {
      console.log('‚è≥ Waiting for Supabase...');
      setTimeout(initSupabase, 100);
      return;
    }
    
    const { createClient } = supabase;
    supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    console.log('‚úÖ Supabase ready!');
    await loadResults();
  }

  async function loadResults() {
    console.log('üîÑ Loading results for room:', roomCode);
    
    try {
      // –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
      const { data: room } = await supabaseClient
        .from('tournament_rooms')
        .select('name')
        .eq('code', roomCode)
        .single();
      
      // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã (—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –æ—á–∫–∞–º)
      const { data: scores } = await supabaseClient
        .from('tournament_scores')
        .select('player_name,score')
        .eq('room_code', roomCode)
        .order('score', { ascending: false });

      console.log('üèÜ Room:', room);
      console.log('üìä Scores:', scores);

      // –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
      if (room) {
        document.getElementById('roomTitle').textContent = room.name;
      } else {
        document.getElementById('roomTitle').textContent = `Tournament ${roomCode.toUpperCase()}`;
      }

      // –õ–∏–¥–µ—Ä–±–æ—Ä–¥
      const leaderboard = document.getElementById('leaderboard');
      if (scores && scores.length > 0) {
        leaderboard.innerHTML = `
          <h2>FINAL RESULTS (${scores.length} players)</h2>
          ${scores.map((score, index) => {
            const classes = [];
            if (index === 0) classes.push('gold', 'winner');
            else if (index === 1) classes.push('silver');
            else if (index === 2) classes.push('bronze');
            
            return `
              <div class="player-row ${classes.join(' ')}">
                <span>${index + 1}Ô∏è‚É£ ${score.player_name}</span>
                <span style="color: #00FF88; font-weight: bold;">${score.score} pts</span>
              </div>
            `;
          }).join('')}
        `;
      } else {
        leaderboard.innerHTML = `
          <h2>FINAL RESULTS</h2>
          <div style="color: #FF6B6B;">üòø No results found for room ${roomCode}</div>
        `;
      }
    } catch (error) {
      console.error('‚ùå Error loading results:', error);
      document.getElementById('leaderboard').innerHTML = `
        <h2>ERROR</h2>
        <div style="color: #FF6B6B;">
          Failed to load: ${error.message} 
          <br><a href="index.html">‚Üê Back to lobby</a>
        </div>
      `;
    }
  }

  // üî• –°–¢–ê–†–¢
  initSupabase();
</script>
