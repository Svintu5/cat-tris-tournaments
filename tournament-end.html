<script>
  const urlParams = new URLSearchParams(window.location.search);
  const roomCode = urlParams.get('room');
  
  const SUPABASE_URL = 'https://lsdwavmfkbfrnbmeqiov.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzZHdhdm1ma2Jmcm5ibWVxaW92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwNzgxMTUsImV4cCI6MjA4MjY1NDExNX0.umbN5OiY95pZMymq3ufuD-jdKdobLScgqqj-57QtU8Y';

  // üî• –ë–ï–ó–û–ü–ê–°–ù–´–ô –î–û–°–¢–£–ü –ö –≠–õ–ï–ú–ï–ù–¢–ê–ú
  const roomTitle = document.getElementById('roomTitle');
  const leaderboard = document.getElementById('leaderboard');
  
  if (!roomCode) {
    if (roomTitle) roomTitle.textContent = '‚ùå No room code';
    if (leaderboard) {
      leaderboard.innerHTML = '<h2>ERROR</h2><div><a href="index.html">‚Üê Lobby</a></div>';
    }
    console.error('No room code');
    return;
  }

  if (!roomTitle || !leaderboard) {
    console.error('DOM elements not found');
    return;
  }

  roomTitle.textContent = `Tournament ${roomCode.toUpperCase()}...`;

  let supabaseClient = null;
  let waitAttempts = 0;

  // üî• –ù–ê–î–Å–ñ–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø —Å FALLBACK
  async function initSupabase() {
    waitAttempts++;
    
    // ‚úÖ Supabase –≥–æ—Ç–æ–≤
    if (typeof supabase !== 'undefined' && supabase.createClient) {
      try {
        const { createClient } = supabase;
        supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('‚úÖ Supabase OK');
        await loadResults();
        return;
      } catch (e) {
        console.error('Supabase init error:', e);
      }
    }
    
    // ‚ùå TIMEOUT 10 —Å–µ–∫ ‚Üí STATIC FALLBACK
    if (waitAttempts > 100) {
      console.log('‚è∞ Supabase timeout ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
      showStaticResults();
      return;
    }
    
    setTimeout(initSupabase, 100);
  }

  // üî• STATIC FALLBACK (—Ä–∞–±–æ—Ç–∞–µ—Ç –ë–ï–ó Supabase)
  function showStaticResults() {
    roomTitle.textContent = `Tournament ${roomCode.toUpperCase()}`;
    leaderboard.innerHTML = `
      <h2>FINAL RESULTS</h2>
      <div style="color: #FF6B6B; padding: 20px;">
        ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã<br>
        <a href="index.html" style="color: #00FF88;">‚Üê –ù–æ–≤–∞—è –∏–≥—Ä–∞</a>
      </div>
    `;
  }

  // üî• –†–ï–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï
  async function loadResults() {
    try {
      console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞:', roomCode);
      
      // –ö–æ–º–Ω–∞—Ç–∞
      const { data: room } = await supabaseClient
        .from('tournament_rooms')
        .select('name')
        .eq('code', roomCode)
        .single().catch(() => ({}));
      
      // –û—á–∫–∏
      const { data: scores } = await supabaseClient
        .from('tournament_scores')
        .select('player_name,score')
        .eq('room_code', roomCode)
        .order('score', { ascending: false });

      console.log('üèÜ –ö–æ–º–Ω–∞—Ç–∞:', room);
      console.log('üìä –û—á–∫–∏:', scores);

      roomTitle.textContent = room?.name || `Tournament ${roomCode.toUpperCase()}`;

      if (scores && scores.length > 0) {
        leaderboard.innerHTML = `
          <h2>FINAL RESULTS (${scores.length} players)</h2>
          ${scores.map((score, i) => {
            const classes = i === 0 ? 'gold winner' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
            return `<div class="player-row ${classes}">
              <span>${i + 1}Ô∏è‚É£ ${score.player_name}</span>
              <span style="color: #00FF88;">${score.score} pts</span>
            </div>`;
          }).join('')}
        `;
      } else {
        leaderboard.innerHTML = `
          <h2>FINAL RESULTS</h2>
          <div style="color: #FF6B6B;">üòø –ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</div>
        `;
      }
    } catch (error) {
      console.error('‚ùå Load error:', error);
      leaderboard.innerHTML = `
        <h2>ERROR</h2>
        <div style="color: #FF6B6B;">
          ${error.message}<br>
          <a href="index.html">‚Üê Lobby</a>
        </div>
      `;
    }
  }

  // üî• –ó–ê–ü–£–°–ö
  console.log('üöÄ tournament-end.html room:', roomCode);
  initSupabase();
</script>
