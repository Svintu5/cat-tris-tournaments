<script>
  const urlParams = new URLSearchParams(window.location.search);
  const roomCode = urlParams.get('room');
  
  const SUPABASE_URL = 'https://lsdwavmfkbfrnbmeqiov.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzZHdhdm1ma2Jmcm5ibWVxaW92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwNzgxMTUsImV4cCI6MjA4MjY1NDExNX0.umbN5OiY95pZMymq3ufuD-jdKdobLScgqqj-57QtU8Y';

  if (!roomCode) {
    document.querySelector('.room-title').textContent = '‚ùå No room code';
    document.querySelector('#leaderboard').innerHTML = '<h2>ERROR</h2><div><a href="index.html">‚Üê Lobby</a></div>';
    throw new Error('No room code');
  }

  let supabaseClient = null;
  let waitAttempts = 0;
  const MAX_WAIT = 50; // 5 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º

  // üî• –ù–ê–î–Å–ñ–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
  function initSupabase() {
    waitAttempts++;
    
    if (typeof supabase !== 'undefined' && supabase.createClient) {
      console.log('‚úÖ Supabase –∑–∞–≥—Ä—É–∂–µ–Ω!');
      const { createClient } = supabase;
      supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      loadResults();
      return;
    }
    
    if (waitAttempts > MAX_WAIT) {
      console.error('üí• Supabase –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –∑–∞ 5 —Å–µ–∫');
      showError('Supabase –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.');
      return;
    }
    
    console.log(`‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ Supabase... (${waitAttempts}/${MAX_WAIT})`);
    setTimeout(initSupabase, 100);
  }

  // üî• –û–®–ò–ë–ö–ê
  function showError(message) {
    document.querySelector('.room-title').textContent = '‚ùå –û—à–∏–±–∫–∞';
    document.getElementById('leaderboard').innerHTML = `
      <h2>–û–®–ò–ë–ö–ê</h2>
      <div style="color: #FF6B6B; padding: 20px;">
        ${message}<br><br>
        <a href="index.html" style="color: #00FF88;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ª–æ–±–±–∏</a>
      </div>
    `;
  }

  // üî• –ó–ê–ì–†–£–ó–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í
  async function loadResults() {
    console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã:', roomCode);
    
    try {
      document.querySelector('.room-title').textContent = `Tournament ${roomCode.toUpperCase()}...`;
      
      // –ö–æ–º–Ω–∞—Ç–∞
      const { data: room, error: roomError } = await supabaseClient
        .from('tournament_rooms')
        .select('name')
        .eq('code', roomCode)
        .single();
      
      if (roomError && roomError.code !== 'PGRST116') { // not found
        throw roomError;
      }

      // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
      const { data: scores, error: scoresError } = await supabaseClient
        .from('tournament_scores')
        .select('player_name,score')
        .eq('room_code', roomCode)
        .order('score', { ascending: false });

      if (scoresError) throw scoresError;

      console.log('üèÜ –ö–æ–º–Ω–∞—Ç–∞:', room);
      console.log('üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:', scores);

      // –ù–∞–∑–≤–∞–Ω–∏–µ
      document.getElementById('roomTitle').textContent = room?.name || `Tournament ${roomCode.toUpperCase()}`;

      // –õ–∏–¥–µ—Ä–±–æ—Ä–¥
      const leaderboard = document.getElementById('leaderboard');
      if (scores && scores.length > 0) {
        leaderboard.innerHTML = `
          <h2>FINAL RESULTS (${scores.length} players)</h2>
          ${scores.map((score, index) => {
            const classes = [];
            if (index === 0) classes.push('gold', 'winner');
            else if (index === 1) classes.push('silver');
            else if (index === 2) classes.push('bronze');
            
            return `
              <div class="player-row ${classes.join(' ')}">
                <span>${index + 1}Ô∏è‚É£ ${score.player_name}</span>
                <span style="color: #00FF88; font-weight: bold;">${score.score} pts</span>
              </div>
            `;
          }).join('')}
        `;
      } else {
        leaderboard.innerHTML = `
          <h2>FINAL RESULTS</h2>
          <div style="color: #FF6B6B;">üòø –ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã ${roomCode}</div>
        `;
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
      showError(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`);
    }
  }

  // üî• –ó–ê–ü–£–°–ö
  console.log('üöÄ –ó–∞–ø—É—Å–∫ tournament-end.html');
  initSupabase();
</script>
